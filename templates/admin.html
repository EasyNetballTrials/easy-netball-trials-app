<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin • Mint Portal Link</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 960px; margin: 40px auto; padding: 0 16px; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 24px; }
    label { font-weight: 600; }
    input, button { width: 100%; padding: 10px; margin: 8px 0 16px; box-sizing: border-box; }
    button { background: #2563eb; color: white; border: none; border-radius: 8px; cursor: pointer; }
    .muted { color:#555; }
    .out { background:#f8fafc; border:1px dashed #cbd5e1; padding:12px; border-radius:8px; word-break: break-all; }
    .err { color:#b91c1c; margin-top: 8px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border:1px solid #e5e7eb; padding:8px 10px; text-align:left; }
    th { background:#f3f4f6; }
    .badge { display:inline-block; padding:2px 8px; border-radius: 999px; font-size: 12px; }
    .ok { background:#dcfce7; color:#14532d; }
    .warn { background:#fee2e2; color:#7f1d1d; }
    .nowrap { white-space: nowrap; }
  </style>
</head>
<body>
  <h1>Admin • Mint Buyer Link</h1>

  {% if not ok %}
  <div class="card">
    <form method="post">
      <label>Admin Password</label>
      <input type="password" name="password" required>
      <label>Buyer Email</label>
      <input type="email" name="email" placeholder="club@example.org" required>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div>
          <label>Access Days (default 30)</label>
          <input type="number" name="days" min="1" max="365" value="30">
        </div>
        <div>
          <label>Max Uses (capped at 10)</label>
          <input type="number" name="uses" min="1" max="10" value="10">
        </div>
      </div>
      <button type="submit">Generate Link</button>
      {% if error %}<div class="err">{{ error }}</div>{% endif %}
      <p class="muted">Tip: set environment variables <code>ADMIN_PASSWORD</code> and <code>NETBALL_SECRET_KEY</code>.</p>
    </form>
  </div>
  {% else %}
  <div class="card">
    <h2>Link ready ✅</h2>
    <p>Buyer: <b>{{ email }}</b></p>
    <p>Access: <b>{{ days }}</b> day(s), Uses: <b>{{ uses }}</b> (max 10)</p>
    <div class="out">{{ link }}</div>
    <p class="muted">Copy & send this link to the buyer.</p>
  </div>
  {% endif %}

  <div class="card">
    <h2>Existing Tokens</h2>
    {% if rows and rows|length > 0 %}
    <table>
      <thead>
        <tr>
          <th>Email</th>
          <th>Token (masked)</th>
          <th class="nowrap">Issued</th>
          <th class="nowrap">Expires</th>
          <th>Days</th>
          <th>Remaining Uses</th>
          <th>Portal Link</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{{ r.email }}</td>
          <td class="nowrap" title="Full link is in the next column">{{ r.token_mask }}</td>
          <td class="nowrap">{{ r.issued_at }}</td>
          <td class="nowrap">{{ r.expires_at }}</td>
          <td>{{ r.days }}</td>
          <td>{{ r.remaining }}</td>
          <td style="word-break:break-all;"><a href="{{ r.link }}" target="_blank">{{ r.link }}</a></td>
          <td>
            {% if r.expired %}
              <span class="badge warn">Expired</span>
            {% elif r.remaining|int <= 0 %}
              <span class="badge warn">No Uses</span>
            {% else %}
              <span class="badge ok">Active</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
      <p class="muted">No tokens minted yet.</p>
    {% endif %}
  </div>
</body>
</html>
